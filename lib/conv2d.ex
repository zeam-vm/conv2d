defmodule Conv2d do
  @moduledoc """
  Documentation for Conv2d.
  """

  def bench_conv({x, y}, {dx, dy}, {n, m}) do
    {i_time, input} = :timer.tc(fn -> matrix(0.0, {x, y}) |> repeat(n) end)
    IO.puts "preparation of input matrices: #{i_time |> Kernel./(1_000_000)} sec."
    {w_time, weight} = :timer.tc(fn -> matrix(0.0, {dx, dy}) |> repeat(m) |> repeat(n) end)
    IO.puts "preparation of weight matrices: #{w_time |> Kernel./(1_000_000)} sec."
    {c_time, result} = :timer.tc(fn -> split_calc(input, weight, {dx, dy}) end)
    IO.puts "calculation of Conv2d: #{c_time |> Kernel./(1_000_000)} sec."
    result
  end

  def bench_conv_1_1 do
    {x, y} = {300, 300}
    {dx, dy} = {3, 3}
    {n, m} = {3, 64}
    bench_conv({x, y}, {dx, dy}, {n, m})
  end

  @doc """

  ## Examples

    iex> Conv2d.foreach(5) |> Enum.to_list
    [0, 1, 2, 3, 4]

  """
  def foreach( n ) when n >= 0 do
    0..(n - 1)
  end

  @doc """

  ## Examples

      iex> Conv2d.repeat(nil, 3)
      [nil, nil, nil]

  """
  def repeat( value, num ) when num >= 0 do
    foreach( num )
    |> Enum.map(fn _ -> value end)
  end

  def matrix(value, {m, n}) do
    value
    |> repeat(m)
    |> repeat(n)
  end

  @doc """
      iex> Conv2d.split_calc([[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]], [[[[1.0, 7.0, 13.0], [19.0, 25.0, 31.0], [37.0, 43.0, 49.0]], [[2.0, 8.0, 14.0], [20.0, 26.0, 32.0], [38.0, 44.0, 50.0]], [[3.0, 9.0, 15.0], [21.0, 27.0, 33.0], [39.0, 45.0, 51.0]]], [[[4.0, 10.0, 16.0], [22.0, 28.0, 34.0], [40.0, 46.0, 52.0]], [[5.0, 11.0, 17.0], [23.0, 29.0, 35.0], [41.0, 47.0, 53.0]], [[6.0, 12.0, 18.0], [24.0, 30.0, 36.0], [42.0, 48.0, 54.0]]]], {3, 3})
      [[[598.5, 615.6, 632.7]]]

      iex> Conv2d.split_calc([[[0.1, 0.3, 0.5, 0.55], [0.7, 0.9, 1.1, 1.15], [1.3, 1.5, 1.7, 1.75], [1.9, 2.1, 2.3, 2.35]],[[0.2, 0.4, 0.6, 0.65], [0.8, 1.0, 1.2, 1.25], [1.4, 1.6, 1.8, 1.85], [2.0, 2.2, 2.4, 2.45]]], [[[[1.0, 7.0, 13.0], [19.0, 25.0, 31.0], [37.0, 43.0, 49.0]], [[2.0, 8.0, 14.0], [20.0, 26.0, 32.0], [38.0, 44.0, 50.0]], [[3.0, 9.0, 15.0], [21.0, 27.0, 33.0], [39.0, 45.0, 51.0]]], [[[4.0, 10.0, 16.0], [22.0, 28.0, 34.0], [40.0, 46.0, 52.0]], [[5.0, 11.0, 17.0], [23.0, 29.0, 35.0], [41.0, 47.0, 53.0]], [[6.0, 12.0, 18.0], [24.0, 30.0, 36.0], [42.0, 48.0, 54.0]]]], {3, 3})
      [[[598.5, 615.6, 632.7], [664.6499999999999, 684.45, 704.25]], [[884.7, 912.5999999999999, 940.5], [950.8499999999999, 981.4499999999999, 1012.0500000000001]]]
  """
  def split_calc( input, weight, {dx, dy} ) do
    {s_time, split} = :timer.tc(fn -> split(input, {dx, dy}) end)

    IO.puts "splitting into matrices: #{s_time |> Kernel./(1_000_000)}"

    {x, y} = size_w(split)
    IO.puts "size of the matrices: #{x}, #{y}"

    {c_time, result} = :timer.tc(fn -> split
      |> Enum.map(fn x ->
        Enum.map(x, fn y ->
          calc(y, weight)
        end)
      end)
    end)

    IO.puts "calculation: #{c_time |> Kernel./(1_000_000)}"

    retult
  end

  @doc """

  ## Examples

      iex> Conv2d.calc([[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]], [[[[1.0, 7.0, 13.0], [19.0, 25.0, 31.0], [37.0, 43.0, 49.0]], [[2.0, 8.0, 14.0], [20.0, 26.0, 32.0], [38.0, 44.0, 50.0]], [[3.0, 9.0, 15.0], [21.0, 27.0, 33.0], [39.0, 45.0, 51.0]]], [[[4.0, 10.0, 16.0], [22.0, 28.0, 34.0], [40.0, 46.0, 52.0]], [[5.0, 11.0, 17.0], [23.0, 29.0, 35.0], [41.0, 47.0, 53.0]], [[6.0, 12.0, 18.0], [24.0, 30.0, 36.0], [42.0, 48.0, 54.0]]]])
      [598.5, 615.6, 632.7]

  """
  def calc( input, weight ) do
    {x, y, n} = size(input)
    {m, ^n} = size_w(weight)
    t_input = input |> dup(m) |> t1
    t_weight = weight |> t1

    mult = Enum.zip(t_input, t_weight) |> Enum.map(& elem(&1, 0) * elem(&1, 1))

    mult
    |> Enum.chunk_every(x * y)
    |> Enum.map(fn x -> x |> Enum.reduce(0, & &1 + &2) end)
    |> Enum.chunk_every(m)
    |> Enum.zip
    |> Enum.map(fn x -> x |> Tuple.to_list |> Enum.reduce(0, & &1 + &2) end)
    |> rt1({x - 2, y - 2, m})
    |> List.flatten
  end

  @doc """

  ## Examples

      iex> Conv2d.size([[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]])
      {3, 3, 2}

      iex> Conv2d.size([[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7], [1.9, 2.1, 2.3]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8], [2.0, 2.2, 2.4]]])
      {3, 4, 2}
  """
  def size( input ) do
    {
      # X
      (input |> hd |> hd |> length),
      # Y
      (input |> hd |> length),
      # N
      (input |> length)
    }
  end

  @doc """

  ## Examples

      iex> Conv2d.size_w([[[[1.0, 7.0, 13.0], [19.0, 25.0, 31.0], [37.0, 43.0, 49.0]], [[2.0, 8.0, 14.0], [20.0, 26.0, 32.0], [38.0, 44.0, 50.0]], [[3.0, 9.0, 15.0], [21.0, 27.0, 33.0], [39.0, 45.0, 51.0]]], [[[4.0, 10.0, 16.0], [22.0, 28.0, 34.0], [40.0, 46.0, 52.0]], [[5.0, 11.0, 17.0], [23.0, 29.0, 35.0], [41.0, 47.0, 53.0]], [[6.0, 12.0, 18.0], [24.0, 30.0, 36.0], [42.0, 48.0, 54.0]]]])
      {3, 2}
  """
  def size_w( input ) do
    {
      # M
      (input |> hd |> length),
      # N
      (input |> length)
    }
  end


  @doc """

  ## Examples

      iex> Conv2d.t1([[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]])
      [0.1, 0.3, 0.5, 0.7, 0.9, 1.1, 1.3, 1.5, 1.7, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8]
  """
  def t1( input ) do
    List.flatten( input )
  end

  @doc """

  ## Examples

      iex> Conv2d.rt1([0.1, 0.3, 0.5, 0.7, 0.9, 1.1, 1.3, 1.5, 1.7, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8], {3, 3, 2})
      [[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]]
  """
  def rt1( input, {x, y, n} ) do
    input
    |> Enum.chunk_every(x)
    |> Enum.chunk_every(y)
    |> Enum.chunk_every(n)
    |> hd
  end

  @doc """

  ## Examples

      iex> Conv2d.dup([[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]],[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]], 3)
      [[[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]], [[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]], [[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]]], [[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]], [[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]], [[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]]]
  """
  def dup( input, m ) do
    input
    |> Enum.map(& Stream.unfold(m, fn
        0 -> nil
        n -> {&1, n - 1}
      end)
      |> Enum.to_list)
  end

  @doc """

  ## Examples

      iex> Conv2d.split([[[0.1, 0.3, 0.5, 0.55], [0.7, 0.9, 1.1, 1.15], [1.3, 1.5, 1.7, 1.75], [1.9, 2.1, 2.3, 2.35]],[[0.2, 0.4, 0.6, 0.65], [0.8, 1.0, 1.2, 1.25], [1.4, 1.6, 1.8, 1.85], [2.0, 2.2, 2.4, 2.45]]], {3, 3})
      [[[[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]], [[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]], [[[0.3, 0.5, 0.55], [0.9, 1.1, 1.15], [1.5, 1.7, 1.75]], [[0.4, 0.6, 0.65], [1.0, 1.2, 1.25], [1.6, 1.8, 1.85]]]], [[[[0.7, 0.9, 1.1], [1.3, 1.5, 1.7], [1.9, 2.1, 2.3]], [[0.8, 1.0, 1.2], [1.4, 1.6, 1.8], [2.0, 2.2, 2.4]]], [[[0.9, 1.1, 1.15], [1.5, 1.7, 1.75], [2.1, 2.3, 2.35]], [[1.0, 1.2, 1.25], [1.6, 1.8, 1.85], [2.2, 2.4, 2.45]]]]]

  """
  def split( input, {dx, dy} ) do
    {x, y, _} = size(input)
    split_s( input, dx, dy, x, y )
  end

  defp split_s( _input, dx, dy, x, y ) when dx > x or dy > y do
    raise "dx > x or dy > y"
  end

  defp split_s( input, dx, dy, x, y ) when dx == x and dy == y do
    [[ input ]]
  end

  defp split_s( input, dx, dy, x, y ) do
    input
    |> Enum.map(&
      foreach(y - dy + 1)
      |> Enum.map(fn iy ->
        foreach(x - dx + 1)
        |> Enum.map(fn ix ->
          split_ss( &1, dx, dy, ix, iy )
        end)
      end)
      )
    |> t2()
  end

  @doc """

  ## Examples

      iex> Conv2d.split_ss([[0.1, 0.3, 0.5, 0.55], [0.7, 0.9, 1.1, 1.15], [1.3, 1.5, 1.7, 1.75], [1.9, 2.1, 2.3, 2.35]], 3, 3, 0, 0)
      [[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]]

      iex> Conv2d.split_ss([[0.1, 0.3, 0.5, 0.55], [0.7, 0.9, 1.1, 1.15], [1.3, 1.5, 1.7, 1.75], [1.9, 2.1, 2.3, 2.35]], 3, 3, 1, 0)
      [[0.3, 0.5, 0.55], [0.9, 1.1, 1.15], [1.5, 1.7, 1.75]]
  """
  def split_ss( input, dx, dy, ix, iy ) do
    input
    |> Enum.slice( iy, iy + dy )
    |> Enum.map(& &1 |> Enum.slice( ix, ix + dx ))
  end

  @doc """

    # Examples
      iex> Conv2d.t2([[[[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]], [[0.3, 0.5, 0.55], [0.9, 1.1, 1.15], [1.5, 1.7, 1.75]]], [[[0.7, 0.9, 1.1], [1.3, 1.5, 1.7], [1.9, 2.1, 2.3]], [[0.9, 1.1, 1.15], [1.5, 1.7, 1.75], [2.1, 2.3, 2.35]]]], [[[[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]], [[0.4, 0.6, 0.65], [1.0, 1.2, 1.25], [1.6, 1.8, 1.85]]], [[[0.8, 1.0, 1.2], [1.4, 1.6, 1.8], [2.0, 2.2, 2.4]], [[1.0, 1.2, 1.25], [1.6, 1.8, 1.85], [2.2, 2.4, 2.45]]]]])
      [[[[[0.1, 0.3, 0.5], [0.7, 0.9, 1.1], [1.3, 1.5, 1.7]], [[0.2, 0.4, 0.6], [0.8, 1.0, 1.2], [1.4, 1.6, 1.8]]], [[[0.3, 0.5, 0.55], [0.9, 1.1, 1.15], [1.5, 1.7, 1.75]], [[0.4, 0.6, 0.65], [1.0, 1.2, 1.25], [1.6, 1.8, 1.85]]]], [[[[0.7, 0.9, 1.1], [1.3, 1.5, 1.7], [1.9, 2.1, 2.3]], [[0.8, 1.0, 1.2], [1.4, 1.6, 1.8], [2.0, 2.2, 2.4]]], [[[0.9, 1.1, 1.15], [1.5, 1.7, 1.75], [2.1, 2.3, 2.35]], [[1.0, 1.2, 1.25], [1.6, 1.8, 1.85], [2.2, 2.4, 2.45]]]]]
  """
  def t2( input ) do
    input
    |> Enum.zip
    |> Enum.map(& Tuple.to_list(&1))
    |> Enum.map(& Enum.zip(&1))
    |> Enum.map(fn x -> Enum.map(x, & Tuple.to_list(&1)) end)
  end
end
